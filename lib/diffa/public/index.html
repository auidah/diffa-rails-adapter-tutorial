<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Diffa participant Grid</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>SlickGrid example 1: Basic grid</title>
  <link rel="stylesheet" href="vendor/slickgrid/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="vendor/slickgrid/css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
</head>
<style>
.slick-cell.active input { width: 100%; }
</style>
<body>
<h1>Diffa participant Grid</h1>

<div id="myGrid" style="height:20em"></div>
<button id="addRow">Add Row</button>
<button id="save">Save</button>
<span id="status"></span>
<hr/>

<script src="vendor/slickgrid/lib/jquery-1.7.min.js"></script>
<script src="vendor/slickgrid/lib/jquery-ui-1.8.16.custom.min.js"></script>
<script src="vendor/slickgrid/lib/jquery.event.drag-2.0.min.js"></script>

<script src="vendor/slickgrid/slick.core.js"></script>
<script src="vendor/slickgrid/slick.grid.js"></script>
<script src="vendor/slickgrid/slick.editors.js"></script>

<script>
  var grid;
  var columns = [
    {id: "id", name: "Id", field: "id", width: 120, editor: Slick.Editors.Text},
    {id: "version", name: "Version", width: 120, field: "version", editor: Slick.Editors.Text},
  ];

  var options = {
    enableCellNavigation: true,
    enableColumnReorder: false,
    editable: true
  };

  window.Diffa = window.Diffa || new Object;
  Diffa.data = [
	  { id: 'sample-id0', version: 'sample-version0' }
  ];

  Diffa.gridView = new Slick.Grid("#myGrid", Diffa.data, columns, options);

  $(function DiffaOnLoad () {
    $.ajax({
        dataType: 'json', 
        url: '/data',
    }).done(function(data) {
        /* I can only pray to be eaten first for this. */
        Diffa.data.splice(0, Diffa.data.length);
        data.forEach(function(e) { Diffa.data.push(e); });
	Diffa.gridView.updateRowCount();
        Diffa.gridView.render()
    }).fail(function() { 
        console.log("Fail: ", arguments);
    });

    $('#addRow').click(function() {
	var num = Diffa.data.length
	var ndata = {id: "Id" + num, version: "Version " + num }
	Diffa.data.push(ndata);
	Diffa.gridView.updateRowCount();
	Diffa.gridView.render();
    });
	
    $('#save').click(function() {
        $('#status').html($('<span class="waiting">In progress</span>'));
	jQuery.ajax({
	    type: 'POST',
	    dataType: 'json',
	    url: '/',
	    contentType: "application/json",
	    data: JSON.stringify(Diffa.data)
	}).complete(function(event, state) {
	    console.log("Save -> ", state);
	}).done(function() {
	    $('#status').html($('<span class="done">Done</span>'));
	}).fail(function() { 
	/* TODO: Proper error handling! */
            console.log("Fail: ", arguments);
        });
    })
   console.log("init done");
  });
</script>
</body>
</html>
